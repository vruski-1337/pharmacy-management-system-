{% extends "base.html" %}

{% block title %}Dashboard - Pharmacy Management System{% endblock %}

{% block content %}
<h2 class="mb-4">
    <i class="fas fa-chart-line"></i> Dashboard
</h2>

<!-- Key Metrics -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="stat-card">
            <div class="stat-icon"><i class="fas fa-dollar-sign"></i></div>
            <div class="stat-label">Today's Sales</div>
            <div class="stat-value">₹{{ "%.2f"|format(metrics.today_sales) }}</div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="stat-card">
            <div class="stat-icon"><i class="fas fa-chart-bar"></i></div>
            <div class="stat-label">Monthly Sales</div>
            <div class="stat-value">₹{{ "%.2f"|format(metrics.month_sales) }}</div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="stat-card">
            <div class="stat-icon"><i class="fas fa-chart-pie" style="color: #28a745;"></i></div>
            <div class="stat-label">Total Profit</div>
            <div class="stat-value" style="color: #28a745;">₹{{ "%.2f"|format(metrics.total_profit) }}</div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="stat-card">
            <div class="stat-icon"><i class="fas fa-shopping-cart"></i></div>
            <div class="stat-label">Total Purchases</div>
            <div class="stat-value">₹{{ "%.2f"|format(metrics.total_purchases) }}</div>
        </div>
    </div>
</div>

<!-- Alerts and Warnings -->
<div class="row mb-4">
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-exclamation-triangle"></i> Stock Status
            </div>
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <span>Low Stock Items</span>
                    <span class="badge bg-danger">{{ metrics.low_stock_count }}</span>
                </div>
                <a href="{{ url_for('inventory.low_stock_report') }}" class="btn btn-sm btn-outline-danger w-100">
                    View Low Stock →
                </a>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-hourglass-end"></i> Expiry Status
            </div>
            <div class="card-body">
                <div class="d-flex justify-content-between mb-2">
                    <small>30 Days</small>
                    <span class="badge bg-info">{{ metrics.expiring_30 }}</span>
                </div>
                <div class="d-flex justify-content-between mb-2">
                    <small>60 Days</small>
                    <span class="badge bg-info">{{ metrics.expiring_60 }}</span>
                </div>
                <div class="d-flex justify-content-between mb-3">
                    <small>90 Days</small>
                    <span class="badge bg-info">{{ metrics.expiring_90 }}</span>
                </div>
                <a href="{{ url_for('inventory.expiry_report') }}" class="btn btn-sm btn-outline-info w-100">
                    View Expiry Report →
                </a>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-alert-circle"></i> Quick Stats
            </div>
            <div class="card-body">
                <div class="d-flex justify-content-between mb-2">
                    <span>Total Customers</span>
                    <span class="badge bg-primary">{{ metrics.total_customers }}</span>
                </div>
                <div class="d-flex justify-content-between mb-3">
                    <span>Total Suppliers</span>
                    <span class="badge bg-primary">{{ metrics.total_suppliers }}</span>
                </div>
                <a href="{{ url_for('alerts.alerts') }}" class="btn btn-sm btn-outline-primary w-100">
                    View All Alerts →
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Charts and Recent Sales -->
<div class="row">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-chart-line"></i> Sales Trend (Last 7 Days)
            </div>
            <div class="card-body">
                <canvas id="salesChart" style="max-height: 300px;"></canvas>
            </div>
        </div>
    </div>
    
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-receipt"></i> Quick Actions
            </div>
            <div class="card-body">
                <a href="{{ url_for('sales.pos') }}" class="btn btn-primary w-100 mb-2">
                    <i class="fas fa-cash-register"></i> Open POS
                </a>
                <a href="{{ url_for('inventory.add_product') }}" class="btn btn-info w-100 mb-2">
                    <i class="fas fa-plus"></i> Add Product
                </a>
                <a href="{{ url_for('purchases.add_purchase') }}" class="btn btn-warning w-100 mb-2">
                    <i class="fas fa-shopping-cart"></i> New Purchase
                </a>
                <a href="{{ url_for('customers.add_customer') }}" class="btn btn-success w-100 mb-2">
                    <i class="fas fa-user-plus"></i> Add Customer
                </a>
                <a href="{{ url_for('suppliers.add_supplier') }}" class="btn btn-dark w-100">
                    <i class="fas fa-truck"></i> Add Supplier
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Recent Sales -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <span><i class="fas fa-history"></i> Recent Transactions</span>
                    <a href="{{ url_for('sales.invoices_list') }}" class="btn btn-sm btn-outline-primary">View All →</a>
                </div>
            </div>
            <div class="card-body">
                {% if recent_sales %}
                <div class="table-responsive">
                    <table class="table table-sm table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>Invoice #</th>
                                <th>Customer</th>
                                <th>Date & Time</th>
                                <th>Amount</th>
                                <th>Payment</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for sale in recent_sales %}
                            <tr>
                                <td>
                                    <a href="{{ url_for('sales.invoice_detail', sale_id=sale.id) }}" class="text-decoration-none">
                                        <strong>{{ sale.invoice_number }}</strong>
                                    </a>
                                </td>
                                <td>{{ sale.customer_name or 'Walk-in' }}</td>
                                <td>{{ sale.invoice_date.strftime('%Y-%m-%d %H:%M') }}</td>
                                <td><strong>₹{{ "%.2f"|format(sale.total_amount) }}</strong></td>
                                <td>
                                    <span class="badge bg-{{ 'success' if sale.payment_status == 'paid' else 'warning' }}">
                                        {{ sale.payment_status.upper() }}
                                    </span>
                                </td>
                                <td>
                                    <a href="{{ url_for('sales.invoice_detail', sale_id=sale.id) }}" class="btn btn-xs btn-outline-primary">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="text-muted text-center py-3">No sales yet. <a href="{{ url_for('sales.pos') }}">Open POS to make a sale.</a></p>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Sales chart
    const ctx = document.getElementById('salesChart').getContext('2d');
    const salesData = {{ sales_by_day | tojson }};
    const labels = Object.keys(salesData);
    const data = Object.values(salesData);
    
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Sales Amount (₹)',
                data: data,
                borderColor: '#1a472a',
                backgroundColor: 'rgba(26, 71, 42, 0.1)',
                borderWidth: 2,
                fill: true,
                tension: 0.4,
                pointBackgroundColor: '#1a472a',
                pointBorderColor: '#fff',
                pointBorderWidth: 2,
                pointRadius: 4,
                pointHoverRadius: 6
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    display: true,
                    position: 'top'
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return '₹' + value.toLocaleString();
                        }
                    }
                }
            }
        }
    });
</script>
{% endblock %}
