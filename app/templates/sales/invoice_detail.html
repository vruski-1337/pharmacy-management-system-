{% extends "base.html" %}

{% block title %}Invoice {{ sale.invoice_number }} - Pharmacy Management System{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header with Invoice Number and Actions -->
    <div class="row mb-4">
        <div class="col-md-8">
            <h1><i class="fas fa-receipt"></i> Invoice {{ sale.invoice_number }}</h1>
            <p class="text-muted">Date: {{ sale.invoice_date.strftime('%Y-%m-%d %H:%M:%S') }}</p>
        </div>
        <div class="col-md-4 text-end">
            <div class="btn-group" role="group">
                <a href="{{ url_for('sales.print_invoice', sale_id=sale.id) }}" class="btn btn-outline-secondary" target="_blank">
                    <i class="fas fa-print"></i> Print
                </a>
                <a href="{{ url_for('sales.download_invoice_pdf', sale_id=sale.id) }}" class="btn btn-outline-info">
                    <i class="fas fa-download"></i> PDF
                </a>
                {% if not sale.is_cancelled %}
                <a href="{{ url_for('sales.process_return', sale_id=sale.id) }}" class="btn btn-outline-warning">
                    <i class="fas fa-undo"></i> Return
                </a>
                <button class="btn btn-outline-danger" data-bs-toggle="modal" data-bs-target="#cancelModal">
                    <i class="fas fa-times"></i> Cancel
                </button>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Status Alert -->
    {% if sale.is_cancelled %}
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        <i class="fas fa-ban"></i>
        <strong>This invoice has been cancelled.</strong>
        {% if sale.cancellation_reason %}
        Reason: {{ sale.cancellation_reason }}
        {% endif %}
    </div>
    {% endif %}

    <div class="row">
        <!-- Invoice Details -->
        <div class="col-lg-8">
            <!-- Company & Customer Info -->
            <div class="card mb-4">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="text-secondary">FROM</h6>
                            <strong>{{ sale.company.company_name }}</strong><br>
                            {% if sale.company.company_address %}
                            <small class="text-muted">{{ sale.company.company_address }}</small><br>
                            {% endif %}
                            {% if sale.company.company_phone %}
                            <small class="text-muted">Phone: {{ sale.company.company_phone }}</small>
                            {% endif %}
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-secondary">BILL TO</h6>
                            <strong>{{ sale.customer_name or 'Walk-in Customer' }}</strong><br>
                            {% if sale.customer and sale.customer.customer_address %}
                            <small class="text-muted">{{ sale.customer.customer_address }}</small><br>
                            {% endif %}
                            {% if sale.customer_phone %}
                            <small class="text-muted">Phone: {{ sale.customer_phone }}</small>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Items Table -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Invoice Items</h5>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Product</th>
                                <th class="text-center">Batch</th>
                                <th class="text-end">Quantity</th>
                                <th class="text-end">Unit Price</th>
                                <th class="text-end">Discount</th>
                                <th class="text-end">Tax</th>
                                <th class="text-end">Amount</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in sale.items %}
                            <tr>
                                <td>
                                    <strong>{{ item.product.product_name }}</strong><br>
                                    <small class="text-muted">SKU: {{ item.product.sku }}</small>
                                </td>
                                <td class="text-center">
                                    <small>{{ item.batch_number or 'N/A' }}</small>
                                </td>
                                <td class="text-end">{{ item.quantity }}</td>
                                <td class="text-end">₹{{ "%.2f"|format(item.unit_price) }}</td>
                                <td class="text-end">₹{{ "%.2f"|format(item.discount_amount) }}</td>
                                <td class="text-end">₹{{ "%.2f"|format(item.tax_amount) }}</td>
                                <td class="text-end"><strong>₹{{ "%.2f"|format(item.total_amount) }}</strong></td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Notes -->
            {% if sale.notes %}
            <div class="card">
                <div class="card-body">
                    <h6 class="text-secondary">Notes</h6>
                    <p>{{ sale.notes }}</p>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Summary Sidebar -->
        <div class="col-lg-4">
            <!-- Payment Summary -->
            <div class="card mb-4">
                <div class="card-header bg-light">
                    <h6 class="mb-0">Payment Summary</h6>
                </div>
                <div class="card-body">
                    <div class="row mb-2">
                        <div class="col-6">Subtotal:</div>
                        <div class="col-6 text-end">₹{{ "%.2f"|format(sale.subtotal) }}</div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-6">Tax:</div>
                        <div class="col-6 text-end">₹{{ "%.2f"|format(sale.tax_amount) }}</div>
                    </div>
                    <div class="row mb-3 pb-3 border-bottom">
                        <div class="col-6">Discount:</div>
                        <div class="col-6 text-end">-₹{{ "%.2f"|format(sale.discount_amount) }}</div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-6"><strong>Total Amount:</strong></div>
                        <div class="col-6 text-end"><strong>₹{{ "%.2f"|format(sale.total_amount) }}</strong></div>
                    </div>
                </div>
            </div>

            <!-- Payment Details -->
            <div class="card mb-4">
                <div class="card-header bg-light">
                    <h6 class="mb-0">Payment Details</h6>
                </div>
                <div class="card-body">
                    <div class="row mb-2">
                        <div class="col-6">Method:</div>
                        <div class="col-6 text-end">
                            <span class="badge bg-secondary">{{ sale.payment_method.upper() }}</span>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-6">Status:</div>
                        <div class="col-6 text-end">
                            {% if sale.is_cancelled %}
                                <span class="badge bg-danger">CANCELLED</span>
                            {% else %}
                                <span class="badge bg-{{ 'success' if sale.payment_status == 'paid' else 'warning' }}">
                                    {{ sale.payment_status.upper() }}
                                </span>
                            {% endif %}
                        </div>
                    </div>
                    {% if sale.customer and sale.customer_id %}
                    <div class="row mt-3 pt-3 border-top">
                        <div class="col-6">Customer Balance:</div>
                        <div class="col-6 text-end">
                            <strong class="text-{{ 'danger' if sale.customer.current_balance > 0 else 'success' }}">
                                ₹{{ "%.2f"|format(sale.customer.current_balance) }}
                            </strong>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Back Button -->
            <a href="{{ url_for('sales.invoices_list') }}" class="btn btn-outline-secondary w-100">
                <i class="fas fa-arrow-left"></i> Back to Invoices
            </a>
        </div>
    </div>
</div>

<!-- Cancel Invoice Modal -->
<div class="modal fade" id="cancelModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Cancel Invoice</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="post" action="{{ url_for('sales.cancel_invoice', sale_id=sale.id) }}">
                <div class="modal-body">
                    <p class="text-danger">
                        <i class="fas fa-exclamation-triangle"></i>
                        <strong>Warning:</strong> Cancelling this invoice will reverse all stock movements and customer balances.
                    </p>
                    <div class="mb-3">
                        <label for="cancellationReason" class="form-label">Reason for Cancellation</label>
                        <textarea id="cancellationReason" name="cancellation_reason" class="form-control" rows="3" required></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-times"></i> Cancel Invoice
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}
