{% extends "base.html" %}

{% block title %}Print Invoice {{ sale.invoice_number }} - Pharmacy Management System{% endblock %}

{% block extra_css %}
<style>
    @media print {
        body {
            margin: 0;
            padding: 0;
            background: white;
        }
        @page { size: A5; margin: 10mm; }
        .no-print {
            display: none !important;
        }
        .invoice-container {
            margin: 0;
            padding: 20px;
        }
    }
    
    .invoice-container {
        max-width: 800px;
        margin: 20px auto;
        background: white;
        padding: 40px;
        border: 1px solid #ddd;
    }
    
    .invoice-header {
        text-align: center;
        margin-bottom: 30px;
        border-bottom: 2px solid #333;
        padding-bottom: 20px;
    }
    
    .invoice-header h1 {
        margin: 0;
        font-size: 28px;
    }
    
    .invoice-number {
        font-size: 14px;
        color: #666;
        margin-top: 10px;
    }
    
    .invoice-details {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 40px;
        margin-bottom: 40px;
    }
    
    .company-info, .customer-info {
        font-size: 12px;
    }
    
    .company-info h6, .customer-info h6 {
        color: #666;
        font-weight: bold;
        margin-bottom: 5px;
        font-size: 11px;
        text-transform: uppercase;
    }
    
    .company-info p, .customer-info p {
        margin: 3px 0;
    }
    
    .items-table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 30px;
    }
    
    .items-table thead {
        background-color: #f5f5f5;
        border-top: 2px solid #333;
        border-bottom: 2px solid #333;
    }
    
    .items-table th {
        padding: 10px;
        text-align: left;
        font-weight: bold;
        font-size: 12px;
    }
    
    .items-table td {
        padding: 10px;
        border-bottom: 1px solid #ddd;
        font-size: 11px;
    }
    
    .items-table .text-right {
        text-align: right;
    }
    
    .summary {
        margin-bottom: 30px;
        border-top: 2px solid #333;
        padding-top: 20px;
    }
    
    .summary-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 8px;
        font-size: 12px;
    }
    
    .summary-row.total {
        font-weight: bold;
        font-size: 14px;
        padding-top: 10px;
        border-top: 1px solid #ddd;
    }
    
    .payment-info {
        background-color: #f9f9f9;
        padding: 15px;
        border-radius: 4px;
        font-size: 11px;
        margin-bottom: 20px;
    }
    
    .footer {
        text-align: center;
        font-size: 10px;
        color: #999;
        border-top: 1px solid #ddd;
        padding-top: 20px;
        margin-top: 20px;
    }
    
    .print-buttons {
        margin-bottom: 20px;
    }
</style>
{% endblock %}

{% block content %}
<div class="no-print print-buttons">
    <div class="container" style="margin-bottom: 20px;">
        <button onclick="printInvoice()" class="btn btn-primary">
            <i class="fas fa-print"></i> Print Invoice
        </button>
        <a href="{{ url_for('sales.invoice_detail', sale_id=sale.id) }}" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> Back
        </a>
    </div>
</div>

<div class="invoice-container">
    <!-- Invoice Header -->
    <div class="invoice-header">
        <h1>{{ sale.company.company_name }}</h1>
        <div class="invoice-number">
            <strong>INVOICE #{{ sale.invoice_number }}</strong><br>
            Date: {{ sale.invoice_date.strftime('%d-%m-%Y %H:%M') if sale.invoice_date else '' }}
        </div>
    </div>

    <!-- Company & Customer Details -->
    <div class="invoice-details">
        <div class="company-info">
            <h6>From:</h6>
            <p><strong>{{ sale.company.company_name }}</strong></p>
            {% if sale.company.company_address %}
            <p>{{ sale.company.company_address }}</p>
            {% endif %}
            {% if sale.company.company_phone %}
            <p>Phone: {{ sale.company.company_phone }}</p>
            {% endif %}
            {% if sale.company.company_email %}
            <p>Email: {{ sale.company.company_email }}</p>
            {% endif %}
        </div>
        
        <div class="customer-info">
            <h6>Bill To:</h6>
            <p><strong>{{ sale.customer_name or 'Walk-in Customer' }}</strong></p>
            {% if sale.customer and sale.customer.customer_address %}
            <p>{{ sale.customer.customer_address }}</p>
            {% endif %}
            {% if sale.customer_phone %}
            <p>Phone: {{ sale.customer_phone }}</p>
            {% endif %}
            {% if sale.customer and sale.customer.customer_email %}
            <p>Email: {{ sale.customer.customer_email }}</p>
            {% endif %}
        </div>
    </div>

    <!-- Items Table -->
    <table class="items-table">
        <thead>
            <tr>
                <th>Product</th>
                <th class="text-right">Qty</th>
                <th class="text-right">Unit Price</th>
                <th class="text-right">Discount</th>
                <th class="text-right">Tax</th>
                <th class="text-right">Amount</th>
            </tr>
        </thead>
        <tbody>
            {% for item in sale.items %}
            <tr>
                <td>
                    <strong>{{ item.product.product_name }}</strong>
                    <br><small>Batch: {{ item.batch_number or 'N/A' }}</small>
                </td>
                <td class="text-right">{{ item.quantity }}</td>
                <td class="text-right">₹{{ "%.2f"|format(item.unit_price) }}</td>
                <td class="text-right">₹{{ "%.2f"|format(item.discount_amount) }}</td>
                <td class="text-right">₹{{ "%.2f"|format(item.tax_amount) }}</td>
                <td class="text-right"><strong>₹{{ "%.2f"|format(item.total_amount) }}</strong></td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <!-- Summary -->
    <div class="summary">
        <div class="summary-row">
            <span>Subtotal:</span>
            <span>₹{{ "%.2f"|format(sale.subtotal) }}</span>
        </div>
        <div class="summary-row">
            <span>Tax Amount:</span>
            <span>₹{{ "%.2f"|format(sale.tax_amount) }}</span>
        </div>
        {% if sale.discount_amount > 0 %}
        <div class="summary-row">
            <span>Discount:</span>
            <span>-₹{{ "%.2f"|format(sale.discount_amount) }}</span>
        </div>
        {% endif %}
        <div class="summary-row total">
            <span>TOTAL AMOUNT:</span>
            <span>₹{{ "%.2f"|format(sale.total_amount) }}</span>
        </div>
    </div>

    <!-- Payment Information -->
    <div class="payment-info">
        <strong>Payment Method:</strong> {{ sale.payment_method.upper() }}<br>
        <strong>Payment Status:</strong> {{ sale.payment_status.upper() }}<br>
        {% if sale.notes %}
        <strong>Notes:</strong> {{ sale.notes }}
        {% endif %}
    </div>

    <!-- Footer -->
    <div class="footer">
        <p>
            Thank you for your business!<br>
            This is a computer-generated invoice.
        </p>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function printInvoice() {
    const content = document.querySelector('.invoice-container');
    if (!content) {
        window.print();
        return;
    }

    const w = window.open('', '_blank', 'width=800,height=600');
    const styles = `
        <style>
        @page { size: A5; margin: 10mm; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial; color: #222; }
        .invoice-container { padding: 10px; }
        table { width:100%; border-collapse: collapse; }
        .items-table th, .items-table td { padding: 6px; }
        </style>`;

    w.document.write('<!doctype html><html><head><title>Invoice</title>' + styles + '</head><body>');
    w.document.write(content.innerHTML);
    w.document.write('</body></html>');
    w.document.close();
    w.focus();
    setTimeout(function(){ w.print(); w.close(); }, 300);
}
</script>
{% endblock %}
