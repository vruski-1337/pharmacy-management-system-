{% extends "base.html" %}

{% block title %}Add Product - Pharmacy Management System{% endblock %}

{% block content %}
<h2 class="mb-4">Add New Product</h2>

<form method="POST" enctype="multipart/form-data">
    <div class="mb-3">
        <label class="form-label">Bulk upload (CSV)</label>
        <div class="input-group mb-2">
            <input type="file" class="form-control" id="bulk_file" name="bulk_file" accept=".csv">
            <a class="btn btn-outline-secondary" href="{{ url_for('inventory.download_products_template') }}">Download Template</a>
        </div>
        <div class="d-flex gap-2">
            <button type="submit" name="upload_csv" value="1" class="btn btn-primary">Upload CSV</button>
            <small class="text-muted align-self-center">You can download the template, fill product rows and upload as CSV. Required columns: product_name, sku, purchase_price, selling_price, mrp, quantity.</small>
        </div>
    </div>
    <div class="row">
        <div class="col-lg-8">
            <div class="card mb-3">
                <div class="card-header">Basic Information</div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="product_name" class="form-label">Product Name *</label>
                            <input type="text" class="form-control" id="product_name" name="product_name" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="generic_name" class="form-label">Generic Name</label>
                            <input type="text" class="form-control" id="generic_name" name="generic_name">
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="brand" class="form-label">Brand</label>
                            <input type="text" class="form-control" id="brand" name="brand">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="category_id" class="form-label">Category *</label>
                            <div class="input-group">
                                <select class="form-select" id="category_id" name="category_id" required>
                                    <option value="">-- Select Category --</option>
                                    {% for c in categories %}
                                    <option value="{{ c.id }}">{{ c.name }}</option>
                                    {% endfor %}
                                </select>
                                <a class="btn btn-outline-secondary" href="{{ url_for('master.categories_list') }}">Manage</a>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="manufacturer" class="form-label">Manufacturer</label>
                            <input type="text" class="form-control" id="manufacturer" name="manufacturer">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="batch_number" class="form-label">Batch Number</label>
                            <input type="text" class="form-control" id="batch_number" name="batch_number">
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="card mb-3">
                <div class="card-header">Inventory & Pricing</div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="sku" class="form-label">SKU *</label>
                            <input type="text" class="form-control" id="sku" name="sku" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="barcode" class="form-label">Barcode</label>
                            <input type="text" class="form-control" id="barcode" name="barcode">
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="purchase_price" class="form-label">Purchase Price *</label>
                            <input type="number" class="form-control" id="purchase_price" name="purchase_price" step="0.01" required>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="selling_price" class="form-label">Selling Price *</label>
                            <input type="number" class="form-control" id="selling_price" name="selling_price" step="0.01" required>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="mrp" class="form-label">MRP *</label>
                            <input type="number" class="form-control" id="mrp" name="mrp" step="0.01" required>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="tax_percentage" class="form-label">Tax %</label>
                            <input type="number" class="form-control" id="tax_percentage" name="tax_percentage" step="0.01" value="0">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="quantity" class="form-label">Quantity *</label>
                            <input type="number" class="form-control" id="quantity" name="quantity" required>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="unit_id" class="form-label">Unit</label>
                            <div class="input-group">
                                <select class="form-select" id="unit_id" name="unit_id">
                                    <option value="">-- Select Unit --</option>
                                    {% for u in units %}
                                    <option value="{{ u.id }}">{{ u.name }}{% if u.abbreviation %} ({{ u.abbreviation }}){% endif %}</option>
                                    {% endfor %}
                                </select>
                                <a class="btn btn-outline-secondary" href="{{ url_for('master.units_list') }}">Manage</a>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="minimum_stock_level" class="form-label">Minimum Stock Level</label>
                            <input type="number" class="form-control" id="minimum_stock_level" name="minimum_stock_level" value="10">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="reorder_level" class="form-label">Reorder Level</label>
                            <input type="number" class="form-control" id="reorder_level" name="reorder_level" value="20">
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="card mb-3">
                <div class="card-header">Dates & More</div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="manufacturing_date" class="form-label">Manufacturing Date</label>
                            <input type="date" class="form-control" id="manufacturing_date" name="manufacturing_date">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="expiry_date" class="form-label">Expiry Date</label>
                            <input type="date" class="form-control" id="expiry_date" name="expiry_date">
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="prescription_required" name="prescription_required">
                            <label class="form-check-label" for="prescription_required">
                                Prescription Required
                            </label>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="description" class="form-label">Description</label>
                        <textarea class="form-control" id="description" name="description" rows="3"></textarea>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-4">
            <div class="card">
                <div class="card-header">Product Image</div>
                <div class="card-body">
                    <div class="mb-3">
                        <input type="file" class="form-control" id="product_image" name="product_image" accept="image/*">
                        <small class="text-muted">PNG, JPG, JPEG, GIF (Max 16MB)</small>
                    </div>
                    <div id="imagePreview" class="text-center">
                        <img id="previewImg" src="#" alt="Product Preview" style="max-width: 100%; display: none;">
                    </div>
                </div>
            </div>
            
            <div class="card mt-3">
                <div class="card-header">Actions</div>
                <div class="card-body">
                    <button type="submit" class="btn btn-primary w-100 mb-2">Add Product</button>
                    <a href="{{ url_for('inventory.products_list') }}" class="btn btn-secondary w-100">Cancel</a>
                </div>
            </div>
        </div>
    </div>
</form>

<script>
document.getElementById('product_image').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            const img = document.getElementById('previewImg');
            img.src = e.target.result;
            img.style.display = 'block';
        };
        reader.readAsDataURL(file);
    }
});
</script>
{% endblock %}
