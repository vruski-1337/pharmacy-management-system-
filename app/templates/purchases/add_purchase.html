{% extends "base.html" %}

{% block title %}Add Purchase - Pharmacy Management System{% endblock %}

{% block content %}
<div class="mb-4">
    <a href="{{ url_for('purchases.purchases_list') }}" class="btn btn-sm btn-secondary">
        <i class="fas fa-arrow-left"></i> Back to Purchases
    </a>
</div>

<h2 class="mb-4">Create New Purchase Order</h2>

<div class="row">
    <div class="col-lg-8">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Purchase Details</h5>
            </div>
            <div class="card-body">
                <form method="POST" id="purchaseForm">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="supplierId" class="form-label">Supplier <span class="text-danger">*</span></label>
                            <select id="supplierId" name="supplier_id" class="form-select" required>
                                <option value="">Select Supplier</option>
                                {% for supplier in suppliers %}
                                <option value="{{ supplier.id }}">{{ supplier.supplier_name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="purchaseNumber" class="form-label">PO Number</label>
                            <input type="text" id="purchaseNumber" class="form-control" value="{{ auto_po_number }}" readonly>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="purchaseDate" class="form-label">Purchase Date</label>
                            <input type="date" id="purchaseDate" name="purchase_date" class="form-control" required>
                        </div>
                        <div class="col-md-6">
                            <label for="supplierInvoice" class="form-label">Supplier Invoice Number</label>
                            <input type="text" id="supplierInvoice" name="supplier_invoice_number" class="form-control" placeholder="Optional">
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Order Items</label>
                        <div id="itemsContainer">
                            <div class="purchase-item mb-3 p-3 border rounded">
                                <div class="row mb-2">
                                    <div class="col-md-5">
                                        <label class="form-label">Product <span class="text-danger">*</span></label>
                                        <select name="product_id" class="form-select product-select" required onchange="updateItemDetails(this)">
                                            <option value="">Select Product</option>
                                            {% for product in products %}
                                            <option value="{{ product.id }}" data-price="{{ product.purchase_price }}">{{ product.product_name }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="col-md-2">
                                        <label class="form-label">Quantity</label>
                                        <input type="number" name="quantity" class="form-control qty-input" min="1" required>
                                    </div>
                                    <div class="col-md-2">
                                        <label class="form-label">Unit Price</label>
                                        <input type="number" name="unit_price" class="form-control price-input" step="0.01" required>
                                    </div>
                                    <div class="col-md-2">
                                        <label class="form-label">Total</label>
                                        <input type="text" class="form-control total-display" readonly>
                                    </div>
                                    <div class="col-md-1 d-flex align-items-end">
                                        <button type="button" class="btn btn-sm btn-danger w-100" onclick="removeItem(this)">Remove</button>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-4">
                                        <label class="form-label">Batch Number</label>
                                        <input type="text" name="batch_number" class="form-control" required>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Expiry Date</label>
                                        <input type="date" name="expiry_date" class="form-control" required>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Tax %</label>
                                        <input type="number" name="tax_percentage" class="form-control" value="0" step="0.01" min="0">
                                    </div>
                                </div>
                            </div>
                        </div>
                        <button type="button" class="btn btn-outline-success" onclick="addItem()">
                            <i class="fas fa-plus"></i> Add Item
                        </button>
                    </div>

                    <hr>

                    <div class="row">
                        <div class="col-md-6"></div>
                        <div class="col-md-6">
                            <div class="mb-2 d-flex justify-content-between">
                                <strong>Subtotal:</strong>
                                <span id="subtotal">₹0.00</span>
                            </div>
                            <div class="mb-2 d-flex justify-content-between">
                                <strong>Tax Amount:</strong>
                                <span id="taxAmount">₹0.00</span>
                            </div>
                            <div class="mb-3 d-flex justify-content-between">
                                <strong>Discount:</strong>
                                <div>
                                    <input type="number" id="discount" name="discount" class="form-control form-control-sm" style="width: 100px; display: inline-block;" value="0" step="0.01" onchange="calculateTotal()">
                                </div>
                            </div>
                            <div class="mb-3 d-flex justify-content-between border-top pt-2" style="font-size: 1.2rem; font-weight: bold;">
                                <strong>Total Amount:</strong>
                                <span id="totalAmount">₹0.00</span>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="notes" class="form-label">Notes</label>
                        <textarea id="notes" name="notes" class="form-control" rows="2"></textarea>
                    </div>

                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary btn-lg">
                            <i class="fas fa-save"></i> Create Purchase Order
                        </button>
                        <a href="{{ url_for('purchases.purchases_list') }}" class="btn btn-outline-secondary">Cancel</a>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Help</h5>
            </div>
            <div class="card-body">
                <p><strong>Tips for creating purchase orders:</strong></p>
                <ul class="small">
                    <li>Select supplier first</li>
                    <li>Add products with quantity and batch details</li>
                    <li>Set expiry dates for tracking</li>
                    <li>Apply taxes if applicable</li>
                    <li>Review totals before submitting</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<script>
// Set today's date
document.getElementById('purchaseDate').valueAsDate = new Date();

function addItem() {
    const container = document.getElementById('itemsContainer');
    const newItem = container.firstElementChild.cloneNode(true);
    newItem.querySelectorAll('input, select').forEach(el => {
        el.value = '';
    });
    newItem.querySelector('.total-display').textContent = '₹0.00';
    container.appendChild(newItem);
}

function removeItem(btn) {
    const container = document.getElementById('itemsContainer');
    if (container.children.length > 1) {
        btn.closest('.purchase-item').remove();
        calculateTotal();
    }
}

function updateItemDetails(select) {
    const price = select.options[select.selectedIndex].dataset.price || 0;
    select.closest('.purchase-item').querySelector('.price-input').value = price;
    calculateTotal();
}

document.addEventListener('input', function(e) {
    if (e.target.classList.contains('qty-input') || e.target.classList.contains('price-input')) {
        const item = e.target.closest('.purchase-item');
        const qty = parseFloat(item.querySelector('.qty-input').value) || 0;
        const price = parseFloat(item.querySelector('.price-input').value) || 0;
        item.querySelector('.total-display').textContent = '₹' + (qty * price).toFixed(2);
        calculateTotal();
    }
});

function calculateTotal() {
    let subtotal = 0;
    let taxAmount = 0;
    
    document.querySelectorAll('.purchase-item').forEach(item => {
        const qty = parseFloat(item.querySelector('.qty-input').value) || 0;
        const price = parseFloat(item.querySelector('.price-input').value) || 0;
        const tax = parseFloat(item.querySelector('input[name="tax_percentage"]').value) || 0;
        
        const itemTotal = qty * price;
        subtotal += itemTotal;
        taxAmount += itemTotal * (tax / 100);
    });
    
    const discount = parseFloat(document.getElementById('discount').value) || 0;
    const total = subtotal + taxAmount - discount;
    
    document.getElementById('subtotal').textContent = '₹' + subtotal.toFixed(2);
    document.getElementById('taxAmount').textContent = '₹' + taxAmount.toFixed(2);
    document.getElementById('totalAmount').textContent = '₹' + Math.max(0, total).toFixed(2);
}

// Initial calculation
calculateTotal();
</script>
{% endblock %}
